data_dir  = "/var/consul/config/"
log_level = "DEBUG"

datacenter         = "{{env "DATACENTER"}}"
primary_datacenter = "{{env "PRIMARY_DATACENTER"}}"

{{if eq (env "SERVER") "true"}}
ui               = true
server           = true
bootstrap_expect = {{env "CONSUL_SERVERS"}}

verify_incoming = false

retry_join_wan = {{env "DATACENTERS"}}

auto_encrypt = {
  allow_tls = {{ if eq (env "CONSUL_SSL") "true" }}true{{ else }}false{{end}}
}
{{end}}

{{if eq (env "CONSUL_SSL") "true"}}
ca_file   = "/var/certs/fullchain.pem"
cert_file = "/var/certs/cert.pem"
key_file  = "/var/certs/privkey.pem"
verify_outgoing = true
encrypt = "{{env "CONSUL_ENCRYPT_KEY"}}" 
{{end}}

{{if eq (env "SERVER") "false"}}
start_join = ["{{env "SERVER_IP"}}"]
{{end}}

bind_addr   = "0.0.0.0"
client_addr = "0.0.0.0"

ports {
  grpc  = 8502
  https = {{ if eq (env "CONSUL_SSL") "true" }}{{ env "CONSUL_PORT" }}{{ else }}-1{{end}}
  http  = {{ if eq (env "CONSUL_SSL") "true" }}-1{{ else }}{{ env "CONSUL_PORT" }}{{end}}
}

advertise_addr = "{{env "IP_ADDRESS"}}"

acl = {
  enabled        = true
  default_policy = "allow"
  down_policy    = "extend-cache"
}

enable_central_service_config = true

connect {
  enabled = true
}
